<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Scanner with Airtable</title>
</head>
<body>
    <h1>NFC Scanner with Lookup</h1>
    <button id="startScan">Start NFC Scan</button>
    <div id="output"></div>

    <script>
        const API_KEY = 'patzZ6CbTcDkaxdpS.79173b498ca77f4302860f25f5b2228809538fc337f98133e925dfa2fc9e676f'; // Replace with your Airtable API key
        const BASE_ID = 'appCd5sXFHe4Y0p6t'; // Replace with your base ID
        const NFC_TABLE = 'tblaM88SIxY8VgoR7'; // Name of the NFC table
        const SCAN_LOG_TABLE = 'tblpHg1ljypWgKkp0'; // Name of the Scan Log table

        const headers = {
            Authorization: `Bearer ${API_KEY}`,
            'Content-Type': 'application/json',
        };

        const startNfcScan = async () => {
            const output = document.getElementById('output');
            output.textContent = "Waiting for NFC scan...";

            if ('NDEFReader' in window) {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    output.textContent = "NFC scan started. Tap a tag.";
                    
                    ndef.addEventListener('reading', event => {
                        const { serialNumber } = event;
                        output.textContent = `NFC Tag Scanned: ${serialNumber}`;

                        // Step 1: Fetch record from NFC table
                        fetchNfcRecord(serialNumber);
                    });
                } catch (error) {
                    console.error('Error starting NFC scan:', error);
                    output.textContent = "NFC scan failed. Ensure your device supports NFC and try again.";
                }
            } else {
                output.textContent = "Web NFC is not supported in this browser.";
            }
        };

        const fetchNfcRecord = (nfcUID) => {
            fetch(`https://api.airtable.com/v0/${BASE_ID}/${NFC_TABLE}?filterByFormula={NFC_UID}='${nfcUID}'`, {
                method: 'GET',
                headers: headers,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.records.length > 0) {
                        const record = data.records[0]; // Fetch the first matching record
                        const monsterId = record.fields.Monster_ID;
                        const locationName = record.fields.Location || 'Unknown';

                        // Display information
                        const output = document.getElementById('output');
                        output.textContent = `NFC UID: ${nfcUID}\nMonster: ${monsterId}\nLocation: ${locationName}`;

                        // Step 2: Log the scan
                        logScanToAirtable(nfcUID, monsterId, locationName);
                    } else {
                        alert('No matching record found in NFC table.');
                    }
                })
                .catch(error => console.error('Error fetching NFC record:', error));
        };

        const logScanToAirtable = (nfcUID, monsterId, locationName) => {
            const userId = "example_user_id"; // Replace with dynamic user ID if needed
            const scanLogRecord = {
                fields: {
                    NFC_UID: nfcUID,
                    Monster_ID: monsterId,
                    Location: locationName,
                    Scanned_By: userId,
                    Scan_Timestamp: new Date().toISOString(),
                },
            };

            fetch(`https://api.airtable.com/v0/${BASE_ID}/${SCAN_LOG_TABLE}`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ records: [scanLogRecord] }),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Scan logged:', data);
                    alert('Scan successfully logged!');
                })
                .catch(error => console.error('Error logging scan:', error));
        };

        document.getElementById('startScan').addEventListener('click', startNfcScan);
    </script>
</body>
</html>
